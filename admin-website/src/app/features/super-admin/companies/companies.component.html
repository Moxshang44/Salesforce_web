<div class="dashboard-layout">
  <!-- Super Admin Sidebar Navigation -->
  <app-super-admin-sidebar></app-super-admin-sidebar>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Header -->
    <app-header></app-header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <div class="companies-header">
        <h1 class="page-title">Company Management</h1>
        <div class="header-actions">
          <app-button variant="primary" (click)="openAddModal()">
            + Add Company
          </app-button>
        </div>
      </div>

      <div class="companies-content">
    @if (listErrorMessage) {
      <div class="alert alert-error">
        {{ listErrorMessage }}
        <button class="retry-btn" (click)="loadCompanies()">Retry</button>
      </div>
    }
    
    @if (isLoading) {
      <div class="loading-state">
        <p>Loading companies...</p>
      </div>
    } @else if (companies.length === 0) {
      <app-card>
        <div class="empty-state">
          <p>No companies found. Click "Add Company" to create your first company.</p>
        </div>
      </app-card>
    } @else {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="col-actions">Actions</th>
              <th class="col-name">Company Name</th>
              <th class="col-active">Is Active</th>
              <th class="col-assign">Assign</th>
            </tr>
          </thead>
          <tbody>
            @for (company of companies; track company.id || company.name) {
              <tr class="table-row">
                <td class="col-actions">
                  <div class="action-buttons">
                    <button class="action-icon edit-icon" (click)="onEdit(company)" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="action-icon view-icon" (click)="onView(company)" title="View">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button 
                      class="action-icon delete-icon" 
                      (click)="onDelete(company)" 
                      [disabled]="isDeleting"
                      title="Delete"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="col-name">{{ company.name }}</td>
                <td class="col-active">
                  <button 
                    class="status-button"
                    [class.active]="company.is_active"
                    [class.inactive]="!company.is_active"
                    (click)="toggleActive(company)"
                  >
                    {{ company.is_active ? 'True' : 'False' }}
                  </button>
                </td>
                <td class="col-assign">
                  <app-button
                    variant="primary"
                    size="sm"
                    (click)="onAssignAdmin(company)"
                  >
                    Assign Admin
                  </app-button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Add Company Modal -->
  <app-modal
    [isOpen]="isAddModalOpen"
    title="Add New Company"
    width="600px"
    (close)="closeAddModal()"
  >
    <form (ngSubmit)="onSubmit()" class="company-form">
      @if (errorMessage) {
        <div class="alert alert-error">
          <strong>Error:</strong>
          <pre class="error-pre">{{ errorMessage }}</pre>
        </div>
      }
      @if (successMessage) {
        <div class="alert alert-success">
          {{ successMessage }}
        </div>
      }

      <div class="form-group">
        <label for="name" class="form-label">Company Name <span class="required">*</span></label>
        <app-input
          id="name"
          type="text"
          [(ngModel)]="companyForm.name"
          name="name"
          placeholder="Enter company name"
          [required]="true"
          [error]="formErrors['name']"
        ></app-input>
      </div>

      <div class="form-group">
        <label for="gst_no" class="form-label">GST Number <span class="required">*</span></label>
        <app-input
          id="gst_no"
          type="text"
          [(ngModel)]="companyForm.gst_no"
          name="gst_no"
          placeholder="Enter GST number"
          [required]="true"
          [error]="formErrors['gst_no']"
        ></app-input>
      </div>

      <div class="form-group">
        <label for="cin_no" class="form-label">CIN Number <span class="required">*</span></label>
        <app-input
          id="cin_no"
          type="text"
          [(ngModel)]="companyForm.cin_no"
          name="cin_no"
          placeholder="Enter CIN number"
          [required]="true"
          [error]="formErrors['cin_no']"
        ></app-input>
      </div>

      <div class="form-group">
        <label for="address" class="form-label">Address <span class="required">*</span></label>
        <textarea
          id="address"
          class="form-textarea"
          [(ngModel)]="companyForm.address"
          name="address"
          placeholder="Enter company address"
          rows="4"
          [required]="true"
        ></textarea>
        @if (formErrors['address']) {
          <div class="error-message">{{ formErrors['address'] }}</div>
        }
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="outline"
          (click)="closeAddModal()"
          [disabled]="isSubmitting"
        >
          Cancel
        </app-button>
        <app-button
          type="submit"
          variant="primary"
          [disabled]="isSubmitting"
          [loading]="isSubmitting"
        >
          Create Company
        </app-button>
      </div>
    </form>
  </app-modal>

  <!-- Edit Company Modal -->
  <app-modal
    [isOpen]="isEditModalOpen"
    title="Edit Company"
    width="600px"
    (close)="closeEditModal()"
  >
    @if (isLoadingEdit) {
      <div class="loading-state">
        <p>Loading company details...</p>
      </div>
    } @else {
      <form (ngSubmit)="onEditSubmit()" class="company-form">
        @if (editErrorMessage) {
          <div class="alert alert-error">
            <strong>Error:</strong>
            <pre class="error-pre">{{ editErrorMessage }}</pre>
          </div>
        }
        @if (editSuccessMessage) {
          <div class="alert alert-success">
            {{ editSuccessMessage }}
          </div>
        }

        <div class="form-group">
          <label for="edit_name" class="form-label">Company Name <span class="required">*</span></label>
          <app-input
            id="edit_name"
            type="text"
            [(ngModel)]="companyForm.name"
            name="edit_name"
            placeholder="Enter company name"
            [required]="true"
            [error]="formErrors['name']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_gst_no" class="form-label">GST Number <span class="required">*</span></label>
          <app-input
            id="edit_gst_no"
            type="text"
            [(ngModel)]="companyForm.gst_no"
            name="edit_gst_no"
            placeholder="Enter GST number"
            [required]="true"
            [error]="formErrors['gst_no']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_cin_no" class="form-label">CIN Number <span class="required">*</span></label>
          <app-input
            id="edit_cin_no"
            type="text"
            [(ngModel)]="companyForm.cin_no"
            name="edit_cin_no"
            placeholder="Enter CIN number"
            [required]="true"
            [error]="formErrors['cin_no']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_address" class="form-label">Address <span class="required">*</span></label>
          <textarea
            id="edit_address"
            class="form-textarea"
            [(ngModel)]="companyForm.address"
            name="edit_address"
            placeholder="Enter company address"
            rows="4"
            [required]="true"
          ></textarea>
          @if (formErrors['address']) {
            <div class="error-message">{{ formErrors['address'] }}</div>
          }
        </div>

        <div class="form-actions">
          <app-button
            type="button"
            variant="outline"
            (click)="closeEditModal()"
            [disabled]="isEditing || isLoadingEdit"
          >
            Cancel
          </app-button>
          <app-button
            type="submit"
            variant="primary"
            [disabled]="isEditing || isLoadingEdit"
            [loading]="isEditing"
          >
            Update Company
          </app-button>
        </div>
      </form>
    }
  </app-modal>

  <!-- View Company Modal -->
  <app-modal
    [isOpen]="isViewModalOpen"
    title="Company Details"
    width="600px"
    (close)="closeViewModal()"
  >
    @if (isLoadingView) {
      <div class="loading-state">
        <p>Loading company details...</p>
      </div>
    } @else if (viewErrorMessage) {
      <div class="alert alert-error">
        <strong>Error:</strong>
        <pre class="error-pre">{{ viewErrorMessage }}</pre>
      </div>
      <div class="form-actions">
        <app-button
          type="button"
          variant="primary"
          (click)="closeViewModal()"
        >
          Close
        </app-button>
      </div>
    } @else if (viewingCompany) {
      <div class="view-company-details">
        <div class="detail-row">
          <div class="detail-label">Company ID:</div>
          <div class="detail-value">{{ viewingCompany.id }}</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label">Company Name:</div>
          <div class="detail-value">{{ viewingCompany.name }}</div>
        </div>

        @if (viewingCompany.gst_no) {
          <div class="detail-row">
            <div class="detail-label">GST Number:</div>
            <div class="detail-value">{{ viewingCompany.gst_no }}</div>
          </div>
        }

        @if (viewingCompany.cin_no) {
          <div class="detail-row">
            <div class="detail-label">CIN Number:</div>
            <div class="detail-value">{{ viewingCompany.cin_no }}</div>
          </div>
        }

        @if (viewingCompany.address) {
          <div class="detail-row">
            <div class="detail-label">Address:</div>
            <div class="detail-value">{{ viewingCompany.address }}</div>
          </div>
        }

        <div class="detail-row">
          <div class="detail-label">Status:</div>
          <div class="detail-value">
            <span 
              class="status-badge-view"
              [class.active]="viewingCompany.is_active"
              [class.inactive]="!viewingCompany.is_active"
            >
              {{ viewingCompany.is_active ? 'Active' : 'Inactive' }}
            </span>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="primary"
          (click)="closeViewModal()"
        >
          Close
        </app-button>
      </div>
    }
  </app-modal>

  <!-- Assign Admin Modal -->
  <app-modal
    [isOpen]="isAssignModalOpen"
    title="Assign Admin"
    width="600px"
    (close)="closeAssignModal()"
  >
    <form (ngSubmit)="onAssignSubmit()" class="company-form">
      @if (selectedCompany) {
        <div class="form-group">
          <label class="form-label">Company</label>
          <div class="selected-company">{{ selectedCompany.name }}</div>
        </div>
      }

      @if (assignErrorMessage) {
        <div class="alert alert-error">
          <strong>Error:</strong>
          <pre class="error-pre">{{ assignErrorMessage }}</pre>
        </div>
      }
      @if (assignSuccessMessage) {
        <div class="alert alert-success">
          {{ assignSuccessMessage }}
        </div>
      }

      <div class="form-group">
        <label for="assign_username" class="form-label">Username <span class="required">*</span></label>
        <app-input
          id="assign_username"
          type="text"
          [(ngModel)]="assignAdminForm.username"
          name="assign_username"
          placeholder="Enter username"
          [required]="true"
          [error]="assignFormErrors['username']"
        ></app-input>
        <small class="form-hint">1-100 characters</small>
      </div>

      <div class="form-group">
        <label for="assign_name" class="form-label">Name <span class="required">*</span></label>
        <app-input
          id="assign_name"
          type="text"
          [(ngModel)]="assignAdminForm.name"
          name="assign_name"
          placeholder="Enter full name"
          [required]="true"
          [error]="assignFormErrors['name']"
        ></app-input>
        <small class="form-hint">1-255 characters</small>
      </div>

      <div class="form-group">
        <label for="assign_contact_no" class="form-label">Contact Number <span class="required">*</span></label>
        <app-input
          id="assign_contact_no"
          type="tel"
          [(ngModel)]="assignAdminForm.contact_no"
          name="assign_contact_no"
          placeholder="Enter contact number"
          [required]="true"
          [error]="assignFormErrors['contact_no']"
        ></app-input>
        <small class="form-hint">1-20 characters</small>
      </div>

      <div class="form-group">
        <label for="assign_role" class="form-label">Role</label>
        <app-input
          id="assign_role"
          type="text"
          [(ngModel)]="assignAdminForm.role"
          name="assign_role"
          placeholder="Enter role (optional)"
        ></app-input>
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="outline"
          (click)="closeAssignModal()"
          [disabled]="isAssigning"
        >
          Cancel
        </app-button>
        <app-button
          type="submit"
          variant="primary"
          [disabled]="isAssigning"
          [loading]="isAssigning"
        >
          Assign Admin
        </app-button>
      </div>
    </form>
  </app-modal>
    </div>
  </div>
</div>

