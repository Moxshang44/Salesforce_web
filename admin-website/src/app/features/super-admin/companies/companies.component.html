<div class="dashboard-layout">
  <!-- Super Admin Sidebar Navigation -->
  <app-super-admin-sidebar></app-super-admin-sidebar>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Header -->
    <app-header></app-header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <div class="companies-header">
        <h1 class="page-title">Company Management</h1>
        <div class="header-actions">
          <app-button variant="primary" (click)="openAddModal()">
            + Add Company
          </app-button>
        </div>
      </div>

      <div class="companies-content">
    @if (listErrorMessage) {
      <div class="alert alert-error">
        {{ listErrorMessage }}
        <button class="retry-btn" (click)="loadCompanies()">Retry</button>
      </div>
    }
    
    @if (isLoading) {
      <div class="loading-state">
        <p>Loading companies...</p>
      </div>
    } @else if (companies.length === 0) {
      <app-card>
        <div class="empty-state">
          <p>No companies found. Click "Add Company" to create your first company.</p>
        </div>
      </app-card>
    } @else {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="col-actions">Actions</th>
              <th class="col-name">Company Name</th>
              <th class="col-roles">Assigned Roles</th>
              <th class="col-admins">Assigned Admin</th>
              <th class="col-role">Role</th>
              <th class="col-assign">Assign</th>
              <th class="col-active">Is Active</th>
            </tr>
          </thead>
          <tbody>
            @for (company of companies; track company.id || company.name) {
              <tr class="table-row">
                <td class="col-actions">
                  <div class="action-buttons">
                    <button class="action-icon edit-icon" (click)="onEdit(company)" title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="action-icon view-icon" (click)="onView(company)" title="View">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button 
                      class="action-icon delete-icon" 
                      (click)="onDelete(company)" 
                      [disabled]="isDeleting"
                      title="Delete"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="col-name">{{ company.name }}</td>
                <td class="col-roles">
                  @if (isLoadingRoles[company.id || '']) {
                    <span class="loading-text">Loading...</span>
                  } @else if (company.roles && company.roles.length > 0) {
                    <div class="roles-list">
                      @for (role of company.roles; track role.id || role.name) {
                        <span class="role-badge">{{ role.name }}</span>
                      }
                    </div>
                  } @else {
                    <span class="no-data">No roles</span>
                  }
                </td>
                <td class="col-admins">
                  @if (isLoadingAdmins[company.id || '']) {
                    <span class="loading-text">Loading...</span>
                  } @else if (company.admins && company.admins.length > 0) {
                    <div class="admins-list">
                      @for (admin of company.admins; track admin.id || admin.username) {
                        <div class="admin-info">
                          <div class="admin-name">{{ admin.name || admin.username || 'N/A' }}</div>
                          <div class="admin-contact">{{ admin.contact_no || 'N/A' }}</div>
                        </div>
                      }
                    </div>
                  } @else {
                    <span class="no-data">No admins</span>
                  }
                </td>
                <td class="col-role">
                  <app-button
                    variant="outline"
                    size="sm"
                    (click)="onAssignRole(company)"
                  >
                    Assign Roles
                  </app-button>
                </td>
                <td class="col-assign">
                  @if (isLoadingAdmins[company.id || '']) {
                    <span class="loading-text">Checking...</span>
                  } @else if (company.hasAdmin) {
                    <div class="assigned-actions">
                      <span class="assigned-badge">Assigned</span>
                      <button
                        type="button"
                        class="add-admin-btn"
                        (click)="onAssignAdmin(company)"
                        title="Assign more admins"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </div>
                  } @else {
                    <app-button
                      variant="primary"
                      size="sm"
                      (click)="onAssignAdmin(company)"
                    >
                      Assign Admin
                    </app-button>
                  }
                </td>
                <td class="col-active">
                  <button 
                    class="status-button"
                    [class.active]="company.is_active"
                    [class.inactive]="!company.is_active"
                    (click)="toggleActive(company)"
                  >
                    {{ company.is_active ? 'True' : 'False' }}
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Add Company Modal -->
  <app-modal
    [isOpen]="isAddModalOpen"
    title="Add New Company"
    width="600px"
    (close)="closeAddModal()"
  >
    <form (ngSubmit)="onSubmit()" class="company-form">
      @if (errorMessage) {
        <div class="alert alert-error">
          <strong>Error:</strong>
          <pre class="error-pre">{{ errorMessage }}</pre>
        </div>
      }
      @if (successMessage) {
        <div class="alert alert-success">
          {{ successMessage }}
        </div>
      }

      <div class="form-group">
        <label for="name" class="form-label">Company Name <span class="required">*</span></label>
        <app-input
          id="name"
          type="text"
          [(ngModel)]="companyForm.name"
          name="name"
          placeholder="Enter company name"
          [required]="true"
          [error]="formErrors['name']"
        ></app-input>
      </div>

      <div class="form-group">
        <label for="gst_no" class="form-label">GST Number <span class="required">*</span></label>
        <input
          id="gst_no"
          type="text"
          class="form-input"
          [class.error]="formErrors['gst_no']"
          [(ngModel)]="companyForm.gst_no"
          name="gst_no"
          placeholder="Enter 15-digit GST number"
          maxlength="15"
          required
          (input)="onGstInput($event)"
        />
        @if (formErrors['gst_no']) {
          <div class="error-message">{{ formErrors['gst_no'] }}</div>
        } @else {
          <small class="form-hint">Must be exactly 15 digits</small>
        }
      </div>

      <div class="form-group">
        <label for="cin_no" class="form-label">CIN Number <span class="required">*</span></label>
        <input
          id="cin_no"
          type="text"
          class="form-input"
          [class.error]="formErrors['cin_no']"
          [(ngModel)]="companyForm.cin_no"
          name="cin_no"
          placeholder="Enter 21-digit CIN number"
          maxlength="21"
          required
          (input)="onCinInput($event)"
        />
        @if (formErrors['cin_no']) {
          <div class="error-message">{{ formErrors['cin_no'] }}</div>
        } @else {
          <small class="form-hint">Must be exactly 21 digits</small>
        }
      </div>

      <div class="form-group">
        <label for="address" class="form-label">Address <span class="required">*</span></label>
        <textarea
          id="address"
          class="form-textarea"
          [(ngModel)]="companyForm.address"
          name="address"
          placeholder="Enter company address"
          rows="4"
          [required]="true"
        ></textarea>
        @if (formErrors['address']) {
          <div class="error-message">{{ formErrors['address'] }}</div>
        }
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="outline"
          (click)="closeAddModal()"
          [disabled]="isSubmitting"
        >
          Cancel
        </app-button>
        <app-button
          type="submit"
          variant="primary"
          [disabled]="isSubmitting"
          [loading]="isSubmitting"
        >
          Create Company
        </app-button>
      </div>
    </form>
  </app-modal>

  <!-- Edit Company Modal -->
  <app-modal
    [isOpen]="isEditModalOpen"
    title="Edit Company"
    width="600px"
    (close)="closeEditModal()"
  >
    @if (isLoadingEdit) {
      <div class="loading-state">
        <p>Loading company details...</p>
      </div>
    } @else {
      <form (ngSubmit)="onEditSubmit()" class="company-form">
        @if (editErrorMessage) {
          <div class="alert alert-error">
            <strong>Error:</strong>
            <pre class="error-pre">{{ editErrorMessage }}</pre>
          </div>
        }
        @if (editSuccessMessage) {
          <div class="alert alert-success">
            {{ editSuccessMessage }}
          </div>
        }

        <div class="form-group">
          <label for="edit_name" class="form-label">Company Name <span class="required">*</span></label>
          <app-input
            id="edit_name"
            type="text"
            [(ngModel)]="companyForm.name"
            name="edit_name"
            placeholder="Enter company name"
            [required]="true"
            [error]="formErrors['name']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_gst_no" class="form-label">GST Number <span class="required">*</span></label>
          <app-input
            id="edit_gst_no"
            type="text"
            [(ngModel)]="companyForm.gst_no"
            name="edit_gst_no"
            placeholder="Enter GST number"
            [required]="true"
            [error]="formErrors['gst_no']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_cin_no" class="form-label">CIN Number <span class="required">*</span></label>
          <app-input
            id="edit_cin_no"
            type="text"
            [(ngModel)]="companyForm.cin_no"
            name="edit_cin_no"
            placeholder="Enter CIN number"
            [required]="true"
            [error]="formErrors['cin_no']"
          ></app-input>
        </div>

        <div class="form-group">
          <label for="edit_address" class="form-label">Address <span class="required">*</span></label>
          <textarea
            id="edit_address"
            class="form-textarea"
            [(ngModel)]="companyForm.address"
            name="edit_address"
            placeholder="Enter company address"
            rows="4"
            [required]="true"
          ></textarea>
          @if (formErrors['address']) {
            <div class="error-message">{{ formErrors['address'] }}</div>
          }
        </div>

        <div class="form-group">
          <label class="form-label">Active Status</label>
          <div class="toggle-container">
            <label class="toggle-switch">
              <input
                type="checkbox"
                [(ngModel)]="companyForm.is_active"
                name="edit_is_active"
                (change)="onActiveToggleChange()"
              >
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">{{ companyForm.is_active ? 'Active' : 'Inactive' }}</span>
          </div>
          <small class="form-hint">Toggle to set company as active or inactive</small>
        </div>

        <div class="form-actions">
          <app-button
            type="button"
            variant="outline"
            (click)="closeEditModal()"
            [disabled]="isEditing || isLoadingEdit"
          >
            Cancel
          </app-button>
          <app-button
            type="submit"
            variant="primary"
            [disabled]="isEditing || isLoadingEdit"
            [loading]="isEditing"
          >
            Update Company
          </app-button>
        </div>
      </form>
    }
  </app-modal>

  <!-- View Company Modal -->
  <app-modal
    [isOpen]="isViewModalOpen"
    title="Company Details"
    width="600px"
    (close)="closeViewModal()"
  >
    @if (isLoadingView) {
      <div class="loading-state">
        <p>Loading company details...</p>
      </div>
    } @else if (viewErrorMessage) {
      <div class="alert alert-error">
        <strong>Error:</strong>
        <pre class="error-pre">{{ viewErrorMessage }}</pre>
      </div>
      <div class="form-actions">
        <app-button
          type="button"
          variant="primary"
          (click)="closeViewModal()"
        >
          Close
        </app-button>
      </div>
    } @else if (viewingCompany) {
      <div class="view-company-details">
        <div class="detail-row">
          <div class="detail-label">Company ID:</div>
          <div class="detail-value">{{ viewingCompany.id }}</div>
        </div>
        
        <div class="detail-row">
          <div class="detail-label">Company Name:</div>
          <div class="detail-value">{{ viewingCompany.name }}</div>
        </div>

        @if (viewingCompany.gst_no) {
          <div class="detail-row">
            <div class="detail-label">GST Number:</div>
            <div class="detail-value">{{ viewingCompany.gst_no }}</div>
          </div>
        }

        @if (viewingCompany.cin_no) {
          <div class="detail-row">
            <div class="detail-label">CIN Number:</div>
            <div class="detail-value">{{ viewingCompany.cin_no }}</div>
          </div>
        }

        @if (viewingCompany.address) {
          <div class="detail-row">
            <div class="detail-label">Address:</div>
            <div class="detail-value">{{ viewingCompany.address }}</div>
          </div>
        }

        <div class="detail-row">
          <div class="detail-label">Status:</div>
          <div class="detail-value">
            <span 
              class="status-badge-view"
              [class.active]="viewingCompany.is_active"
              [class.inactive]="!viewingCompany.is_active"
            >
              {{ viewingCompany.is_active ? 'Active' : 'Inactive' }}
            </span>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="primary"
          (click)="closeViewModal()"
        >
          Close
        </app-button>
      </div>
    }
  </app-modal>

  <!-- Assign Role Modal -->
  <app-modal
    [isOpen]="isRoleModalOpen"
    title="Assign Role"
    width="600px"
    (close)="closeRoleModal()"
  >
    <form (ngSubmit)="onRoleSubmit()" class="company-form">
      @if (selectedCompanyForRole) {
        <div class="form-group">
          <label class="form-label">Company</label>
          <div class="selected-company">{{ selectedCompanyForRole.name }}</div>
        </div>
      }

      @if (roleErrorMessage) {
        <div class="alert alert-error">
          <strong>Error:</strong>
          <pre class="error-pre">{{ roleErrorMessage }}</pre>
        </div>
      }
      @if (roleSuccessMessage) {
        <div class="alert alert-success">
          {{ roleSuccessMessage }}
        </div>
      }

      <div class="form-group">
        <label for="role_name" class="form-label">Role Name <span class="required">*</span></label>
        <app-input
          id="role_name"
          type="text"
          [(ngModel)]="roleForm.name"
          name="role_name"
          placeholder="Enter role name"
          [required]="true"
          [error]="roleFormErrors['name']"
        ></app-input>
      </div>

      <div class="form-group">
        <label for="role_description" class="form-label">Description <span class="optional">(Optional)</span></label>
        <textarea
          id="role_description"
          class="form-textarea"
          [(ngModel)]="roleForm.description"
          name="role_description"
          placeholder="Enter role description"
          rows="4"
        ></textarea>
        @if (roleFormErrors['description']) {
          <div class="error-message">{{ roleFormErrors['description'] }}</div>
        }
      </div>

      <div class="form-group">
        <label class="form-label">Permissions <span class="optional">(Optional)</span></label>
        <div class="permissions-container">
          <div class="permission-input-group">
            <app-input
              type="text"
              [(ngModel)]="newPermission"
              name="new_permission"
              placeholder="Enter permission"
              (keyup.enter)="addPermission()"
            ></app-input>
            <app-button
              type="button"
              variant="primary"
              size="sm"
              (click)="addPermission()"
            >
              Add
            </app-button>
          </div>
          @if (roleForm.permissions.length > 0) {
            <div class="permissions-list">
              @for (permission of roleForm.permissions; track $index) {
                <div class="permission-tag">
                  <span>{{ permission }}</span>
                  <button
                    type="button"
                    class="remove-permission"
                    (click)="removePermission($index)"
                    title="Remove permission"
                  >
                    Ã—
                  </button>
                </div>
              }
            </div>
          }
        </div>
        @if (roleFormErrors['permissions']) {
          <div class="error-message">{{ roleFormErrors['permissions'] }}</div>
        }
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="outline"
          (click)="closeRoleModal()"
          [disabled]="isRoleAssigning"
        >
          Cancel
        </app-button>
        <app-button
          type="submit"
          variant="primary"
          [disabled]="isRoleAssigning"
          [loading]="isRoleAssigning"
        >
          Create Role
        </app-button>
      </div>
    </form>
  </app-modal>

  <!-- Assign Admin Modal -->
  <app-modal
    [isOpen]="isAssignModalOpen"
    title="Assign Admin"
    width="600px"
    (close)="closeAssignModal()"
  >
    <form (ngSubmit)="onAssignSubmit()" class="company-form">
      @if (selectedCompany) {
        <div class="form-group">
          <label class="form-label">Company</label>
          <div class="selected-company">{{ selectedCompany.name }}</div>
        </div>
      }

      @if (assignErrorMessage) {
        <div class="alert alert-error">
          <strong>Error:</strong>
          <pre class="error-pre">{{ assignErrorMessage }}</pre>
        </div>
      }
      @if (assignSuccessMessage) {
        <div class="alert alert-success">
          {{ assignSuccessMessage }}
        </div>
      }

      <div class="form-group">
        <label for="assign_name" class="form-label">Name <span class="required">*</span></label>
        <app-input
          id="assign_name"
          type="text"
          [(ngModel)]="assignAdminForm.name"
          name="assign_name"
          placeholder="Enter full name"
          [required]="true"
          [error]="assignFormErrors['name']"
        ></app-input>
        <small class="form-hint">1-255 characters</small>
      </div>

      <div class="form-group">
        <label for="assign_contact_no" class="form-label">Contact Number <span class="required">*</span></label>
        <input
          id="assign_contact_no"
          type="tel"
          class="form-input"
          [class.error]="assignFormErrors['contact_no']"
          [(ngModel)]="assignAdminForm.contact_no"
          name="assign_contact_no"
          placeholder="Enter 10-digit contact number"
          maxlength="10"
          required
          (input)="onContactNoInput($event)"
        />
        @if (assignFormErrors['contact_no']) {
          <div class="error-message">{{ assignFormErrors['contact_no'] }}</div>
        } @else {
          <small class="form-hint">Must be exactly 10 digits</small>
        }
      </div>

      <div class="form-group">
        <label for="assign_role" class="form-label">Role</label>
        <app-input
          id="assign_role"
          type="text"
          [(ngModel)]="assignAdminForm.role"
          name="assign_role"
          [disabled]="true"
          placeholder="ADMIN"
        ></app-input>
        <small class="form-hint">Role is set to ADMIN</small>
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="outline"
          (click)="closeAssignModal()"
          [disabled]="isAssigning"
        >
          Cancel
        </app-button>
        <app-button
          type="submit"
          variant="primary"
          [disabled]="isAssigning"
          [loading]="isAssigning"
        >
          Assign Admin
        </app-button>
      </div>
    </form>
  </app-modal>
    </div>
  </div>
</div>

