<div class="form-container">
  <form class="brand-form">
    <!-- Margins Section -->
    <div class="margins-section">
      <div class="margins-header">
        <h3 class="section-title">Margins <span class="optional">(Optional)</span></h3>
        <button type="button" class="add-margin-btn" (click)="addMargin()">
          + Add Margin
        </button>
      </div>

      @if (formData.margins.length > 0) {
        @for (margin of formData.margins; track $index) {
          <div class="margin-card">
            <div class="margin-card-header">
              <h4>Margin Entry {{ $index + 1 }}</h4>
              <button type="button" class="remove-margin-btn" (click)="removeMargin($index)">
                Remove
              </button>
            </div>

            <div class="form-grid">
              <!-- Name -->
              <div class="form-group">
                <label class="form-label">Name <span class="optional">(Optional)</span></label>
                <input 
                  type="text" 
                  class="form-input"
                  [(ngModel)]="margin.name" 
                  [name]="'margin_name_' + $index"
                  placeholder="Enter margin name"
                />
              </div>

              <!-- Area -->
              <div class="form-group">
                <label class="form-label">Area <span class="optional">(Optional)</span></label>
                <select class="form-select" [(ngModel)]="margin.area_id" [name]="'margin_area_' + $index">
                  <option [ngValue]="null">Select Area</option>
                  @for (area of areas; track area.id) {
                    <option [ngValue]="area.id">{{ area.name }}</option>
                  }
                </select>
              </div>
            </div>

            <!-- Margins for each level -->
            <div class="margin-levels-section">
              <h5>Margin Levels</h5>
              <div class="margin-levels-table-wrapper">
                <table class="margin-levels-table">
                  <thead>
                    <tr>
                      <th>Level</th>
                      <th>Type</th>
                      <th>Value (%)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Super Stockist -->
                    <tr>
                      <td>Super Stockist</td>
                      <td>
                        <select class="form-select-small" [(ngModel)]="margin.margins.super_stockist.type" [name]="'margin_type_super_' + $index">
                          @for (type of marginTypes; track type) {
                            <option [value]="type">{{ type }}</option>
                          }
                        </select>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-input-small" 
                          [(ngModel)]="margin.margins.super_stockist.value" 
                          [name]="'margin_value_super_' + $index"
                          placeholder="0"
                        />
                      </td>
                    </tr>

                    <!-- Distributor -->
                    <tr>
                      <td>Distributor</td>
                      <td>
                        <select class="form-select-small" [(ngModel)]="margin.margins.distributor.type" [name]="'margin_type_dist_' + $index">
                          @for (type of marginTypes; track type) {
                            <option [value]="type">{{ type }}</option>
                          }
                        </select>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-input-small" 
                          [(ngModel)]="margin.margins.distributor.value" 
                          [name]="'margin_value_dist_' + $index"
                          placeholder="0"
                        />
                      </td>
                    </tr>

                    <!-- Retailer -->
                    <tr>
                      <td>Retailer</td>
                      <td>
                        <select class="form-select-small" [(ngModel)]="margin.margins.retailer.type" [name]="'margin_type_ret_' + $index">
                          @for (type of marginTypes; track type) {
                            <option [value]="type">{{ type }}</option>
                          }
                        </select>
                      </td>
                      <td>
                        <input 
                          type="number" 
                          class="form-input-small" 
                          [(ngModel)]="margin.margins.retailer.value" 
                          [name]="'margin_value_ret_' + $index"
                          placeholder="0"
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        }
      } @else {
        <div class="empty-state">
          <p>No margins added yet. Click "Add Margin" to add margin information.</p>
        </div>
      }
    </div>
  </form>

  <!-- Action Buttons -->
  <div class="form-actions">
    <app-button 
      variant="outline" 
      type="button"
      (click)="onPrevious()"
    >
      Previous
    </app-button>
    <app-button 
      variant="primary" 
      type="button"
      (click)="onSaveAndFinish()"
    >
      Save & Finish
    </app-button>
  </div>
</div>
